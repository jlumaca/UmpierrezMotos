{% extends "perfil_administrativo/padre_perfil_administrativo.html" %}
{% load static %}

{% block contenidoQueCambia %}
<div class="table-container" id="inventarios">
    <div class="form-container" id="motoForm">
        <h4>Venta</h4>
        {% if messages %}
        <div class="messages">
            <div class="alert alert alert-success">{{ message }}</div>
        </div>
        {% endif %}
        {% if error_message_cliente %}
        <div class="alert alert-danger" role="alert">
            {{ error_message_cliente }} <a href="{% url 'ClienteAlta' %}">aquí</a>
        </div>
        {% endif %}
        {% if error_message %}
        <div class="alert alert-danger" role="alert">
            {{ error_message }}
        </div>
        {% endif %}

        <!-- Formulario de búsqueda de cliente -->
        <form action="" enctype="multipart/form-data" method="POST">{% csrf_token %}
            <div class="mb-3" id="documento_cliente">
                <label for="documento" class="form-label">Documento del cliente</label>
                <div class="input-group">
                    <select class="form-control" name="tipo_documento" id="tipo_documento">
                        <option value="CI">Cédula</option>
                        <option value="PAS">Pasaporte</option>
                        <option value="DNI">DNI</option>
                    </select>
                    <span class="input-group-text">-</span>
                    <input type="number" class="form-control" name="documento" placeholder="Documento">
                    <button class="btn btn-outline-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </form>

        {% if datos_moto %}
        
            <h4>Datos del cliente</h4>
            <table class="table table-bordered">
                <tbody>
                    <tr>
                        <th scope="row">Cliente</th>
                        <td>{{ cliente.nombre }} {{ cliente.apellido }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Documento</th>
                        <td>{{ cliente.documento }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Contacto</th>
                        <td>{{ tel1 }}{% if tel2 %}, {{ tel2 }}{% endif %}</td>
                    </tr>
                    <tr>
                        <th scope="row">Correo</th>
                        <td>{{ correo1 }}{% if correo2 %}, {{ correo2 }}{% endif %}</td>
                    </tr>
                    <tr>
                        <th scope="row">Domicilio</th>
                        <td>{{ cliente.domicilio }}</td>
                    </tr>
                </tbody>
            </table>

            <h4>Datos de la moto</h4>
            <table class="table table-bordered">
                <tbody>
                    <tr>
                        <th scope="row">Código</th>
                        <td>{{ moto.id }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Marca</th>
                        <td>{{ moto.marca }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Modelo</th>
                        <td>{{ moto.modelo }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Motor (cc)</th>
                        <td>{{ moto.motor }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Año</th>
                        <td>{{ moto.anio }}</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- COMPROMISO COMPRA VENTA -->
            {% if logo_cv %}
            <img src="{{ logo_cv }}" alt="Logo de la tienda" style="display: none; width: 200%; max-width: 150px; height: auto;">
            {% endif %}
            <!-- <h2 class="text-center">COMPROMISO DE COMPRAVENTA</h2> -->
            <h4>Compromiso compra venta</h4>
            <form action="{% url 'GCCV' moto.id cliente.id %}" enctype="multipart/form-data" method="POST">{% csrf_token %}
            <div class="mb-3">
                <label for="precio" class="form-label">"Pagaderos de la siguiente forma:..."</label>
                <textarea class="form-control" name="texto_pagaderos" id="texto_pagaderos" placeholder="Detalle la forma de pago acordada con el cliente" rows="3"></textarea>
            </div> 
            <button type="submit" class="btn btn-success">Generar CCV</button>
            <!-- <div class="button-container">
                <button type="button" class="btn btn-primary" onclick="generatePDF()">Generar PDF</button>
            </div> -->
            </form>
            <form action="{% url 'MotoVenta' moto.id cliente.id %}" enctype="multipart/form-data" method="POST">{% csrf_token %}
            <h4>Forma de pago</h4>
            <div class="mb-3">
                <label for="precio" class="form-label">Forma de pago</label>
                <textarea class="form-control" name="forma_pago" id="descripcion" placeholder="Detalle la forma de pago acordada con el cliente" rows="3"></textarea>
            </div> 

            <!-- <div class="mb-3">
                <label for="recargo" class="form-label">Seña</label>
                <input value="0" type="number" class="form-control" name="seña" id="seña" readonly>
            </div>

            <div class="mb-3">
                <label for="recargo" class="form-label">Entrega inicial</label>
                <input value="700" type="number" class="form-control" name="entrega_inicial" id="entrega_inicial" required>
            </div> -->
            

            <div class="mb-3">
                <label for="recargo" class="form-label">Precio</label>
                <input value="{{ precio }}" type="number" class="form-control" name="precio_sin_recargo" id="precio_sin_recargo" readonly>
            </div>

            <div class="mb-3">
                <label for="recargo" class="form-label">Precio restante con entregas y fondos incluidos</label>
                <input value="{{ fondos }}" type="number" class="form-control" name="precio_sin_recargo" id="precio_sin_recargo" readonly>
            </div>

            <div class="mb-3">
                <label for="recargo" class="form-label">Cantidad destinada de los fondos</label>
                <input value="{{ total_fondos }}" type="number" class="form-control" name="cantidad_destinada" id="precio_sin_recargo" required>
            </div>
            

            <div class="mb-3">
                <input type="checkbox" id="sin_num_motor" name="incluir_fondos" class="form-check-input" checked>
                <label for="toggleMatr" class="form-check-label">Incluir los fondos en la compra de la moto</label>
            </div>
            
            
            <!-- <div class="mb-3">
                <label for="recargo" class="form-label">Recargo</label>
                <input type="number" class="form-control" name="recargo" id="recargo" required>
            </div>

            <div class="mb-3">
                <label for="recargo" class="form-label">Cantidad de cuotas</label>
                <input type="number" class="form-control" name="cant_cuotas" id="cant_cuotas" required>
            </div>

            <div class="mb-3">
                <label for="recargo" class="form-label">Valor de cada cuota</label>
                <input type="number" class="form-control" name="valor_cuota" id="valor_cuota" required>
            </div>

            <div class="mb-3">
                <label for="recargo" class="form-label">Precio con recargo incluido</label>
                <input type="number" class="form-control" name="precio_recargo" id="precio_con_recargo" readonly>
            </div>
             -->
            <h4>Documentación</h4>
            <div class="mb-3" id="libreta_propiedad_div">
                <label for="libreta_propiedad" class="form-label">Papel compraventa</label>
                <input type="file" class="form-control" name="compra_venta_moto" id="libreta_propiedad" required>
            </div>
            
            <button type="submit" class="btn btn-success">Generar venta</button>
                <a href="{% url 'Motos' %}" class="btn btn-secondary">Cancelar</a>
        </form>
        {% endif %}
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script>
function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4"); // Configuración para hoja A4

    const margin = 10; // Márgenes estándar
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    let y = margin;

    // Obtener contenido del textarea principal
    const mainContent = document.getElementById("previewText").value;

    // Calcular tamaño dinámico del logo
    const logoWidth = pageWidth / 2; // Tamaño del logo como la mitad del ancho de la página
    const logoHeight = logoWidth * 0.4; // Proporción ajustada (relación de aspecto 5:2)
    const xCenter = (pageWidth - logoWidth) / 2; // Centrar horizontalmente

    // Agregar imagen centrada
    const logo = document.querySelector("img").src; // Asegúrate de que el logo esté cargado
    if (logo) {
        doc.addImage(logo, "JPEG", xCenter, y, logoWidth, logoHeight);
        y += logoHeight + 5; // Espacio después de la imagen
    }

    // Agregar título centrado
    doc.setFont("Arial", "bold");
    doc.setFontSize(14);
    doc.text("COMPROMISO DE COMPRAVENTA", pageWidth / 2, y, { align: "center" });
    y += 10;

    // Agregar contenido principal con formato ajustado
    doc.setFont("Arial", "normal");
    doc.setFontSize(10); // Tamaño del texto
    const lineHeight = 5; // Espaciado entre líneas

    // Ajustar el contenido al margen izquierdo
    mainContent.split("\n").forEach(line => {
        const splitText = doc.splitTextToSize(line, pageWidth - 2 * margin); // Ajustar texto al ancho de la página
        splitText.forEach(subLine => {
            if (y + lineHeight > pageHeight - margin) {
                doc.addPage();
                y = margin;
            }
            doc.text(margin, y, subLine); // Asegura que el texto comience desde el margen izquierdo
            y += lineHeight;
        });
    });

    // Guardar el PDF
    doc.save("compromiso_compra_venta.pdf");
}


function calcularCuotas() {
    // Obtener los valores de los campos
    const seña = parseFloat(document.getElementById("seña").value);
    const entregaInicial = parseFloat(document.getElementById("entrega_inicial").value);
    const cantidadCuotas = parseInt(document.getElementById("cant_cuotas").value);
    const precio = document.getElementById("precio_moto_label").innerText

    // Validar que todos los campos contengan valores numéricos y sean mayores que 0
    if (isNaN(seña) || isNaN(entregaInicial) || isNaN(cantidadCuotas) || cantidadCuotas <= 0) {
        alert("Por favor, ingrese valores válidos para todos los campos.");
        return;
    }

    // Calcular el valor de cada cuota
    const total = precio - seña - entregaInicial;
    const valorCuota = total / cantidadCuotas;

    // Mostrar el valor de cada cuota en el label correspondiente
    document.getElementById("valor_cuota").innerText = `$/U$S${valorCuota.toFixed(2)}`;
}


document.addEventListener('DOMContentLoaded', () => {
    const precio_sin_recargo = document.getElementById('precio_sin_recargo');
    const recargo = document.getElementById('recargo');
    const cant_cuotas = document.getElementById('cant_cuotas');
    const precio_con_recargo = document.getElementById('precio_con_recargo');
    const valor_cuota = document.getElementById('valor_cuota');
    
    

    function calcularRecargo() {
        const valor = parseInt(precio_sin_recargo.value) || 0;
        const porcentaje = parseInt(recargo.value) || 0;
        const cuotas = parseInt(cant_cuotas.value) || 0;
        const calc_valor_cuota = parseInt(valor_cuota.value) || 0;

        // Calcular el recargo basado en el porcentaje ingresado
        const sumar_recargo = (valor * porcentaje * cuotas) / 100;
        const total = valor + sumar_recargo;
        const total_valor_cuota = total / cuotas

        // Actualizar los campos
        precio_con_recargo.value = total.toFixed(0);
        valor_cuota.value = total_valor_cuota.toFixed(0);
    }

    precio_sin_recargo.addEventListener('input', calcularRecargo);
    recargo.addEventListener('input', calcularRecargo);
    cant_cuotas.addEventListener('input', calcularRecargo);
});

document.getElementById('download-btn').addEventListener('click', async () => {
    const url = 'generar_compromiso_compra_venta'; // Cambia por la URL de tu endpoint en Django
    try {
        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) throw new Error('Error al generar el documento');

        // Crear un objeto Blob con los datos recibidos
        const blob = await response.blob();

        // Crear un enlace para descargar el archivo
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = 'documento.docx'; // Nombre del archivo que se descargará
        link.click();

        // Liberar el objeto URL
        window.URL.revokeObjectURL(link.href);

        
        
        
    } catch (error) {
        console.error('Error al descargar el documento:', error);
    }

    // document.getElementById("texto_pagaderos").value = "";
});

</script>

{% endblock %}

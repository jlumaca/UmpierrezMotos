{% extends "perfil_administrativo/padre_perfil_administrativo.html" %}
{% load static %}

{% block contenidoQueCambia %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>


<title>Motos</title>
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
{% endif %}
<div class="table-container" id="inventarios">
    
    <h3>Datos sobre la caja</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Monto inicial</th>
                <th>+Efectivo</th>
                <th>+Transferencia</th>
                <th>+Debito</th>
                <th>-Efectivo</th>
                <th>-Transferencia</th>
                <th>-Debito</th>
                <th>Saldo caja</th>
                <th>Saldo sistema</th>
            </tr>
        </thead>
        <tbody>
                <tr>
                    <td>$4500/U$s100</td>
                    <td>$1000/U$s22,2</td>
                    <td>$5000/U$s111,1</td>
                    <td>
                        +500/U$s11,1
                    </td>
                    <td>-$1000/U$s22,2</td>
                    <td>-$2000/U$s44,4</td>
                    <td>-$0/U$s0,0</td>
                    <td>Aparece al cerrar</td>
                    <td>Aparece al cerrar</td>
                </tr>
        </tbody>
    </table>
    <h3>Resumen de caja</h3>
    <table class="table" id="tabla-resumen">
        <thead>
            <tr>
                <th>Ganancias del mes</th>
                <th>Ganancias del día</th>
                <th>Egresos del día</th>
                <th>Egresos del mes</th>
                <th>Ganancias netas del mes</th>
                <th>Ganancias netas del día</th>
                <th>Ingresos extras del día</th>
                <th>Ingresos extras del mes</th>
                
            </tr>
        </thead>
        <tbody>
                <tr>
                    <td>{{ ganancias_mes }}</td>
                    <td>{{ ganancias_dia }}</td>
                    <td>{{ egresos_dia }}</td>
                    <td>
                        {{ egresos_mes }}
                    </td>
                    <td>{{ ganancias_netas_mes }}</td>
                    <td>{{ ganancias_netas_dia }}</td>
                    <td>{{ ingresos_extra_dia }}</td>
                    <td>{{ ingresos_extra_mes }}</td>
                    
                </tr>
        </tbody>
    </table>
    <h3>Ver detalles</h3>
    <div class="mb-3" id="busqueda_detalles">
        <label for="documento" class="form-label">Ver detalles por</label>
        <select class="form-control" id="detalles_por" onchange="detalles_por()">
            <option value="fecha">Fecha</option>
            <option value="mes">Mes</option>
        </select>
    </div>
    <div id="detalles_x_fecha">
        <form action="{% url 'DetallesCajaXFecha' %}" method="post" id="form-reporte">{% csrf_token %}
            <div class="mb-3">
                <input type="date" class="form-control" name="f_detalles" id="fecha" placeholder="Ingrese la fecha" required>        
            </div>
            <button type="submit" class="btn btn-success" id="btn_fecha">Guardar</button>
        </form>

    </div>

    <div id="detalles_x_mes_anio" style="display: none;">
        <form action="" enctype="multipart/form-data" method="POST">{% csrf_token %}
            <div class="mb-3">
                <div class="d-flex">
                    <select class="form-control" id="detalles_por">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                    <span class="mx-1">-</span>
                    <select class="form-control" id="detalles_por">
                        <option value="fecha">2024</option>
                        <option value="mes">2025</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Guardar</button>
        </form>


    </div>
    <!-- <button class="btn btn-primary" onclick="generarPDF()">Ver detalles PDF</button> -->
    <h3>Movimientos</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Movimiento</th>
                <th>Tipo</th>
                <th>Método</th>
                <th>Moneda</th>
                <th>Monto</th>
                <th>Usuario</th>
            </tr>
        </thead>
        <tbody>
            {% if page_obj %}
                {% for movimiento in page_obj %}
                <tr>
                    <td>{{ movimiento.movimiento.fecha }}</td>
                    <td>{{ movimiento.descripcion }}</td>
                    <td>{{ movimiento.movimiento.tipo }}</td>
                    <td>{{ movimiento.movimiento.metodo }}</td>
                    <td>
                        {{ movimiento.movimiento.moneda }}
                        
                    </td>
                    <td>
                        {% if movimiento.movimiento.tipo == "Egreso" %}
                        <span class="badge bg-danger">-{{ movimiento.movimiento.monto }}</span>
                        {% else %}
                        <span class="badge bg-success">+{{ movimiento.movimiento.monto }}</span>
                        {% endif %}
                    </td>
                    <td>{{ movimiento.usuario }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="9" class="text-center text-muted">
                        No hay registros de movimientos disponibles en esta caja.
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
    <a href="{% url 'Arqueos' %}" class="btn btn-secondary">Volver</a>
    <!-- Paginación -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="Primera">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Siguiente">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Última">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
<!-- Agregar la librería jsPDF y autoTable -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->

<script>
    function generarPDF(data) {
    // debugger;
    console.log("Generando PDF funcion...");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Título del documento
    doc.setFontSize(18);
    doc.setTextColor(40, 40, 40);
    doc.text('Reporte del Estado de caja', 70, 20);
    
    const fecha = data[5]
    const f_desde_json = fecha.fecha.split("-").reverse().join("/");
    doc.setFontSize(10);
    doc.text(`Fecha: ${f_desde_json}`, 15, 25);

    const { subtotal_pesos, subtotal_dolares, total_pesos, total_dolares } = data;

    // Configuración de la tabla
    let datosTabla = data.slice(0, 2).map(item => [
        item.tipo, 
        item.venta, 
        `$ ${item.total_pesos}`, 
        `U$S${item.total_dolares}`
    ]);

    doc.autoTable({
        startY: 30,  // Posición inicial debajo del título
        head: [["Tipo", "Venta", "Total $", "Total U$S"]], // Encabezados de la tabla
        body: datosTabla, // Datos cargados desde la vista
        theme: "grid",  // Estilo de la tabla
        styles: { 
            fontSize: 12, 
            cellPadding: 6, 
            textColor: [30, 30, 30],  // Texto oscuro
            lineColor: [200, 200, 200], // Color de los bordes de celdas
            lineWidth: 0.3 // Grosor de los bordes
        }, 
        headStyles: { 
            fillColor: [0, 102, 204], // Azul más moderno
            textColor: [255, 255, 255], 
            fontSize: 14, 
            fontStyle: 'bold'
        },
        bodyStyles: { 
            textColor: [50, 50, 50], 
            fontSize: 12 
        }, 
        columnStyles: { 
            0: { halign: 'center', cellWidth: 'auto' },  // Tipo
            1: { halign: 'center', cellWidth: 'auto' },  // Venta
            2: { halign: 'right', cellWidth: 'auto' },   // Total $
            3: { halign: 'right', cellWidth: 'auto' }    // Total U$S
        }, 
        alternateRowStyles: { fillColor: [240, 240, 255] } // Suave fondo alterno
    });
    let finalY = doc.lastAutoTable.finalY + 10; // Posición después de la tabla

    // Agregar subtotales y totales debajo de la tabla
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    const filaTres = data[2]; // Accedes al tercer elemento del array 'data'
    
    const ingresos_extra_pesos = filaTres.ingresos_extra ? filaTres.ingresos_extra.toFixed(2) : "0.00";
    doc.text(`Ingresos extra: $ ${ingresos_extra_pesos}`, 20, finalY);

    const ingresos_extra_dolares = filaTres.ingresos_extra_dolares ? filaTres.ingresos_extra_dolares.toFixed(2) : "0.00";
    doc.text(`Ingresos extra: U$s ${ingresos_extra_dolares}`, 120, finalY);

    finalY += 8;
    
    const egresos_pesos = filaTres.egresos ? filaTres.egresos.toFixed(2) : "0.00";
    doc.text(`Egresos: $ ${egresos_pesos}`, 20, finalY);

    const egresos_dolares = filaTres.egresos_dolares ? filaTres.egresos_dolares.toFixed(2) : "0.00";
    doc.text(`Egresos: U$s ${egresos_dolares}`, 120, finalY);

    finalY += 8;

    const subtotalPesos = filaTres.subtotal_pesos ? filaTres.subtotal_pesos.toFixed(2) : "0.00";
    doc.text(`Subtotal Pesos: $ ${subtotalPesos}`, 20, finalY);

    const subtotalDolares = filaTres.subtotal_dolares ? filaTres.subtotal_dolares.toFixed(2) : "0.00";
    doc.text(`Subtotal Dólares: U$S ${subtotalDolares}`, 120, finalY);

    finalY += 8;
    doc.setFontSize(16);
    doc.setTextColor(0, 102, 204);

    const totalPesos = filaTres.total_general_pesos ? filaTres.total_general_pesos.toFixed(2) : "0.00";
    const totalDolares = filaTres.total_general_dolares ? filaTres.total_general_dolares.toFixed(2) : "0.00";


    doc.text(`TOTAL PESOS: $ ${totalPesos}`, 20, finalY);
    doc.text(`TOTAL DÓLARES: U$S ${totalDolares}`, 120, finalY);

    finalY += 15;
    doc.setFontSize(16);
    doc.setTextColor(40, 40, 40);
    doc.text('Detalle de Egresos', 70, finalY);
    finalY += 5;

    const egresosDetalle = data[3].egresos_detalle.map(item => [item.rubro, `$ ${item.valor}`, item.motivo]);

    if (egresosDetalle.length > 0) {
        doc.autoTable({
            startY: finalY,
            head: [["Rubro", "Valor", "Motivo"]],
            body: egresosDetalle,
            theme: "grid",
            styles: { fontSize: 12, textColor: [30, 30, 30], lineColor: [200, 200, 200], lineWidth: 0.3 },
            headStyles: { fillColor: [204, 51, 51], textColor: [255, 255, 255], fontSize: 13, fontStyle: 'bold' },
            bodyStyles: { textColor: [50, 50, 50], fontSize: 12 },
            columnStyles: { 
                0: { halign: 'left' },
                1: { halign: 'right' },
                2: { halign: 'left' }
            },
            alternateRowStyles: { fillColor: [255, 240, 240] }
        });

        finalY = doc.lastAutoTable.finalY + 10;
    }else{
        doc.autoTable({
            startY: finalY,
            head: [["Rubro", "Valor", "Motivo"]],
            theme: "grid",
            styles: { fontSize: 12, textColor: [30, 30, 30], lineColor: [200, 200, 200], lineWidth: 0.3 },
            headStyles: { fillColor: [204, 51, 51], textColor: [255, 255, 255], fontSize: 13, fontStyle: 'bold' },
            bodyStyles: { textColor: [50, 50, 50], fontSize: 12 },
            columnStyles: { 
                0: { halign: 'left' },
                1: { halign: 'right' },
                2: { halign: 'left' }
            },
            alternateRowStyles: { fillColor: [255, 240, 240] }
        });

        finalY = doc.lastAutoTable.finalY + 10;
    }

    // **TABLA DE INGRESOS EXTRA**
    finalY += 5;
    doc.setFontSize(16);
    doc.setTextColor(40, 40, 40);
    doc.text('Detalle de Ingresos Extra', 70, finalY);
    finalY += 5;

    const ingresosExtraDetalle = data[4].ingresos_extra_detalle.map(item => [`$ ${item.valor}`, item.motivo]);

    if (ingresosExtraDetalle.length > 0) {
        doc.autoTable({
            startY: finalY,
            head: [["Valor", "Motivo"]],
            body: ingresosExtraDetalle,
            theme: "grid",
            styles: { fontSize: 12, textColor: [30, 30, 30], lineColor: [200, 200, 200], lineWidth: 0.3 },
            headStyles: { fillColor: [51, 153, 51], textColor: [255, 255, 255], fontSize: 13, fontStyle: 'bold' },
            bodyStyles: { textColor: [50, 50, 50], fontSize: 12 },
            columnStyles: { 
                0: { halign: 'right' },
                1: { halign: 'left' }
            },
            alternateRowStyles: { fillColor: [240, 255, 240] }
        });
    }else{
        doc.autoTable({
            startY: finalY,
            head: [["Valor", "Motivo"]],
            theme: "grid",
            styles: { fontSize: 12, textColor: [30, 30, 30], lineColor: [200, 200, 200], lineWidth: 0.3 },
            headStyles: { fillColor: [51, 153, 51], textColor: [255, 255, 255], fontSize: 13, fontStyle: 'bold' },
            bodyStyles: { textColor: [50, 50, 50], fontSize: 12 },
            columnStyles: { 
                0: { halign: 'right' },
                1: { halign: 'left' }
            },
            alternateRowStyles: { fillColor: [240, 255, 240] }
        });
    }

    // Guardar el archivo PDF
    console.log("Datos recibidos:", data);
    console.log("jsPDF:", window.jspdf);
    console.log("jsPDF autoTable:", window.jspdf?.autoTable);
    doc.save('detalles_caja.pdf');
}
function toggleIngresos(id) {
        const formulario = document.getElementById(`formulario-ingresos-${id}`);
        if (formulario.style.display === "none" || formulario.style.display === "") {
            formulario.style.display = "table-row";
        } else {
            formulario.style.display = "none";
        }
    }
    function toggleEgresos(id) {
        const formulario = document.getElementById(`formulario-egresos-${id}`);
        if (formulario.style.display === "none" || formulario.style.display === "") {
            formulario.style.display = "table-row";
        } else {
            formulario.style.display = "none";
        }
    }
    // import { jsPDF } from "jspdf";
    // import "jspdf-autotable";
    document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('form-reporte').addEventListener('submit', function (event) {
        event.preventDefault();  // Evita la recarga de la página
        
        const fecha = document.querySelector('[name="f_detalles"]').value;  
        
        if (fecha) {
            obtenerDetallesCaja(fecha);  // Llamamos a la función que obtiene los datos y genera el PDF
        } else {
            alert("Por favor selecciona una fecha.");
        }
    });
});

async function obtenerDetallesCaja(fecha) {
    // try {
        // debugger;
        // Hacemos la petición POST al servidor con la fecha
        const response = await fetch('/detalles_caja_x_fecha/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',  // Usamos este tipo de contenido si enviamos un formulario
                'X-CSRFToken': getCookie('csrftoken'),  // Asegúrate de tener el CSRF token configurado correctamente
            },
            body: new URLSearchParams({
                'f_detalles': fecha  // Pasa la fecha como un parámetro
            })
        });
        
        // Verificar si la respuesta fue exitosa
        if (!response.ok) {
            console.error('Error en la respuesta de la API:', response.statusText);
            alert('Hubo un problema al obtener los datos.');
            return;
        }
        
        // Convertir la respuesta JSON en un objeto de JavaScript
        const data = await response.json();
        // console.log(data);  // Verifica los datos recibidos
        
        // Aquí puedes procesar los datos o generar el PDF
        // Generar el PDF con los datos obtenidos
        // console.log("Datos recibidos:", data);
        console.log("LLEGA...");
        console.log(data)
        generarPDF(data);
        // window.location.reload();

    // } catch (error) {
    //     console.error('Hubo un error al hacer la solicitud:', error);
    //     alert('Hubo un error al obtener los detalles.');
    // }
}

// Función para obtener el valor del cookie CSRFToken (si es necesario para el POST)
function getCookie(name) {
    // debugger;
    const value = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
    return value ? value[2] : null;
}

// Función para generar el PDF usando jsPDF



// function generarPDF(data) {
//     // Importar jsPDF y autoTable
//     const { jsPDF } = window.jspdf;
//     const pdf = new jsPDF();

//     // Agregar título
//     pdf.setFontSize(16);
//     pdf.text("Reporte de Caja", 80, 15);

//     // Agregar fecha
//     let fecha = new Date().toLocaleDateString();
//     pdf.setFontSize(12);
//     pdf.text(`Fecha: ${fecha}`, 20, 20);

//     // Transformar los datos recibidos en la estructura que se usará en la tabla
//     let datosTabla = data.map(item => [
//         item.tipo,  // Tipo (Motos o Accesorios)
//         item.venta, // Venta (Cantidad de unidades vendidas)
//         `${item.total_pesos} $`, // Total en Pesos
//         `${item.total_dolares} U$S` // Total en Dólares
//     ]);

//     // Agregar la tabla
//     pdf.autoTable({
//         startY: 40, // Posición inicial en Y
//         head: [["Tipo", "Venta", "Total $", "Total U$S"]],
//         body: datosTabla,
//         theme: "grid", // Estilo de tabla
//         styles: { 
//             fontSize: 12, 
//             cellPadding: 5,
//             cellWidth: 'auto', // Ajustar el ancho de las celdas automáticamente
//         },
//         headStyles: { 
//             fillColor: [0, 0, 255], // Azul para la cabecera
//             textColor: [255, 255, 255], // Texto blanco en la cabecera
//             fontStyle: 'bold' // Texto en negrita para la cabecera
//         },
//         bodyStyles: {
//             fillColor: [255, 255, 255], // Fondo blanco para las filas
//             textColor: [0, 0, 0], // Texto negro para las filas
//         },
//         alternateRowStyles: {
//             fillColor: [240, 240, 240] // Fondo gris claro para filas alternas
//         }
//     });

//     // Descargar el PDF
//     pdf.save("reporte_caja.pdf");
// }




















    function detalles_por(){
        var estado = document.getElementById("detalles_por").value;
        var detalles_x_fecha = document.getElementById("detalles_x_fecha");
        var detalles_x_mes_anio = document.getElementById("detalles_x_mes_anio");

       
       
        if (estado === "fecha") {
            detalles_x_fecha.style.display = "block";
            detalles_x_mes_anio.style.display = "none";
           
        }else{
            detalles_x_fecha.style.display = "none";
            detalles_x_mes_anio.style.display = "block";
           
        }
    }
</script>
{% endblock %}
